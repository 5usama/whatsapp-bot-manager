name: Build WhatsApp Bot APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # 1. CHECKOUT CODE
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    # 2. SETUP ENVIRONMENT
    - name: âš™ï¸ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    # 3. CREATE FRESH REACT NATIVE PROJECT
    - name: ğŸ› ï¸ Create React Native project
      run: |
        echo "ğŸ“ Current files:"
        ls -la
        
        # Create new React Native project
        npx @react-native-community/cli@latest init TempProject --version 0.72.9 --npm --skip-install --template react-native-template-typescript
        echo "âœ… React Native project created"
        
        # Copy Android folder
        cp -r TempProject/android .
        
        # Backup original files
        mkdir -p OriginalFiles
        cp -r screens/ OriginalFiles/ 2>/dev/null || true
        cp App.js OriginalFiles/ 2>/dev/null || true
        cp package.json OriginalFiles/ 2>/dev/null || true
        
        # Clean up
        rm -rf TempProject
        
    # 4. COPY YOUR FILES
    - name: ğŸ“‚ Copy your app files
      run: |
        # Copy your App.js (if exists)
        if [ -f "OriginalFiles/App.js" ]; then
          cp OriginalFiles/App.js .
          echo "âœ… Copied App.js"
        else
          # Create default App.js
          cat > App.js << 'EOF'
import React from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createStackNavigator } from '@react-navigation/stack';
import LoginScreen from './screens/LoginScreen';
import ConnectScreen from './screens/ConnectScreen';
import DashboardScreen from './screens/DashboardScreen';

const Stack = createStackNavigator();

export default function App() {
  return (
    <NavigationContainer>
      <Stack.Navigator initialRouteName="Login">
        <Stack.Screen name="Login" component={LoginScreen} />
        <Stack.Screen name="Connect" component={ConnectScreen} />
        <Stack.Screen name="Dashboard" component={DashboardScreen} />
      </Stack.Navigator>
    </NavigationContainer>
  );
}
EOF
          echo "ğŸ“ Created default App.js"
        fi
        
        # Copy screens folder
        if [ -d "OriginalFiles/screens" ]; then
          cp -r OriginalFiles/screens .
          echo "âœ… Copied screens folder"
        else
          mkdir -p screens
          echo "ğŸ“ Created empty screens folder"
        fi
        
        # Create package.json with exact versions
        cat > package.json << 'EOF'
{
  "name": "whatsapp-bot-manager",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "start": "react-native start",
    "android": "react-native run-android",
    "build": "cd android && ./gradlew assembleDebug"
  },
  "dependencies": {
    "react": "18.2.0",
    "react-native": "0.72.9",
    "@react-navigation/native": "6.1.6",
    "@react-navigation/stack": "6.3.16",
    "react-native-screens": "3.22.1",
    "react-native-safe-area-context": "4.6.3",
    "react-native-gesture-handler": "2.9.0"
  },
  "devDependencies": {
    "@babel/core": "^7.20.0",
    "@babel/runtime": "^7.20.0",
    "metro-react-native-babel-preset": "0.76.7"
  },
  "resolutions": {
    "react-native": "0.72.9"
  }
}
EOF
        echo "âœ… Created package.json"
        
    # 5. INSTALL DEPENDENCIES
    - name: ğŸ“¥ Install dependencies
      run: |
        echo "ğŸ“¦ Installing npm packages..."
        npm install --legacy-peer-deps --no-audit --no-fund
        
        echo "ğŸ“Š Installed packages:"
        npm list --depth=0 2>/dev/null | head -20
        
    # 6. CONFIGURE ANDROID BUILD
    - name: âš™ï¸ Configure Android build
      run: |
        cd android
        
        # Update build.gradle for compatibility
        sed -i 's/com.android.application/com.android.application/' app/build.gradle
        sed -i 's/minSdkVersion = .*/minSdkVersion = 21/' app/build.gradle
        sed -i 's/compileSdkVersion = .*/compileSdkVersion = 33/' app/build.gradle
        sed -i 's/targetSdkVersion = .*/targetSdkVersion = 33/' app/build.gradle
        
        # Create local.properties
        echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties
        
        echo "âœ… Android configured"
        
    # 7. BUILD APK
    - name: ğŸš€ Build APK
      run: |
        cd android
        
        # Make gradlew executable
        chmod +x gradlew
        
        echo "ğŸ”§ Starting Gradle build..."
        ./gradlew assembleDebug --no-daemon --stacktrace
        
        # Check if APK was created
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "âœ… BUILD SUCCESS!"
          echo "ğŸ“¦ APK Size: $APK_SIZE"
        else
          echo "âŒ APK not found!"
          ls -la app/build/outputs/apk/debug/ 2>/dev/null || echo "No debug folder"
          exit 1
        fi
        
    # 8. UPLOAD APK
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: WhatsApp-Bot-Manager-APK
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 90
        
    # 9. SUCCESS MESSAGE
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo ""
        echo "ğŸ‰ğŸ‰ğŸ‰ APK SUCCESSFULLY BUILT! ğŸ‰ğŸ‰ğŸ‰"
        echo "====================================="
        echo ""
        echo "ğŸ“± DOWNLOAD INSTRUCTIONS:"
        echo "1. Go to Actions tab"
        echo "2. Click on this workflow run"
        echo "3. Scroll to 'Artifacts' section"
        echo "4. Click 'WhatsApp-Bot-Manager-APK'"
        echo "5. Download 'app-debug.apk'"
        echo ""
        echo "ğŸ“¦ APK will be ~40-60MB"
        echo "â±ï¸ Build time: ${{ job.status }}"
